<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Messenger Pro Optimized</title>
<style>
:root{--primary:#075e54;--bg:#e5ddd5;--me:#dcf8c6;--them:#fff;}
body{margin:0;font-family:sans-serif;background:#d1d7db;display:flex;justify-content:center;align-items:center;height:100vh;}
.card{background:white;width:100%;max-width:420px;height:100vh;display:flex;flex-direction:column;}
.hidden{display:none!important;}
header{background:var(--primary);color:white;padding:15px;display:flex;justify-content:space-between;align-items:center;}
.room-item{padding:12px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;cursor:pointer;}
.room-item:hover{background:#f5f5f5;}
#chat-box{flex:1;overflow-y:auto;padding:10px;background:var(--bg);display:flex;flex-direction:column;}
.msg{margin:6px 0;padding:8px 12px;border-radius:12px;max-width:75%;font-size:14px;}
.msg-me{align-self:flex-end;background:var(--me);}
.msg-them{align-self:flex-start;background:var(--them);}
.msg img,.msg video{max-width:100%;border-radius:8px;margin-top:5px;}
.input-area{display:flex;gap:6px;padding:8px;background:#f0f0f0;}
input{flex:1;padding:8px;border-radius:20px;border:1px solid #ccc;}
button{background:var(--primary);color:white;border:none;padding:7px 12px;border-radius:20px;cursor:pointer;}
.admin-panel{background:#f3f3f3;padding:8px;font-size:12px;overflow:auto;}
.badge{font-size:10px;padding:2px 6px;border-radius:4px;margin-left:5px;background:#075e54;color:white;}
.newchat-btn{margin-top:10px;width:100%;padding:10px;border-radius:8px;}
</style>
</head>
<body>

<!-- Room List -->
<div id="screen-list" class="card">
<header>
<span>Messenger</span>
<span onclick="showSettings()" style="cursor:pointer;">‚öô</span>
</header>
<div id="room-list" style="flex:1;overflow:auto;"></div>
<button class="newchat-btn" onclick="showSetup()">+ New Chat</button>
</div>

<!-- Setup -->
<div id="screen-setup" class="card hidden" style="padding:20px;">
<h3>Create / Join Room</h3>
<input id="room-name" placeholder="Room name">
<label style="margin-top:10px;display:block;">
<input type="checkbox" id="privateBox"> Private Room
</label>
<input id="room-pass" type="password" placeholder="Set password" style="display:none;margin-top:10px;">
<button onclick="createRoom()">Create Room</button>
<button onclick="joinRoom()">Join Room</button>
<button onclick="showList()">Cancel</button>
</div>

<!-- Chat -->
<div id="screen-chat" class="card hidden">
<header>
<button onclick="showList()">‚Üê</button>
<span id="room-title"></span>
</header>
<div id="admin-panel" class="admin-panel hidden"></div>
<div id="chat-box"></div>
<div class="input-area">
<input id="msg" placeholder="Message" oninput="checkInput()">
<input type="file" id="fileInput" accept="image/*,video/*" hidden>
<button onclick="pickFile()">üìé</button>
<button id="sendBtn" onclick="sendMsg()" disabled>‚û§</button>
</div>
</div>

<!-- Settings -->
<div id="screen-settings" class="card hidden" style="padding:20px;">
<h3>Settings</h3>
<label>Name:</label>
<input id="settings-name">
<label style="margin-top:10px;">PIN:</label>
<input id="settings-pin" type="password">
<button style="margin-top:10px;" onclick="saveSettings()">Save</button>
<button style="margin-top:5px;" onclick="showList()">Back</button>
</div>

<script>
/* ===== CONFIG ===== */
const BIN_ID="6995c8e9ae596e708f347d9b";
const API_KEY="$2a$10$Xoj7gk3UMX/Xu39sZjITbe1vTxinpZ3KjHuDNvIBeVmMqxBLt5HC.";
const BASE="https://api.jsonbin.io/v3/b/"+BIN_ID;
const SUPER_PIN="3108";

let myID=localStorage.getItem("uid")||crypto.randomUUID();
localStorage.setItem("uid",myID);
let myName=localStorage.getItem("name")||prompt("Your name:");
localStorage.setItem("name",myName);
let pin=localStorage.getItem("pin")||prompt("Create PIN:");
localStorage.setItem("pin",pin);
if(prompt("Enter PIN:")!==pin) document.body.innerHTML="Locked";
let isSuperAdmin=(pin===SUPER_PIN);
let currentRoom=null;
let cachedMessages=[];

/* ===== UTILITIES ===== */
function hideAll(){document.querySelectorAll(".card").forEach(c=>c.classList.add("hidden"));}
function showList(){hideAll();document.getElementById("screen-list").classList.remove("hidden"); renderRooms();}
function showSetup(){hideAll();document.getElementById("screen-setup").classList.remove("hidden");}
function showSettings(){
  hideAll();
  document.getElementById("screen-settings").classList.remove("hidden");
  document.getElementById("settings-name").value=myName;
  document.getElementById("settings-pin").value=pin;
}
document.getElementById("privateBox").onchange=function(){
  document.getElementById("room-pass").style.display=this.checked?"block":"none";
}
function checkInput(){document.getElementById("sendBtn").disabled=!document.getElementById("msg").value.trim();}

/* ===== JSONBIN ===== */
async function getData(){try{const r=await fetch(BASE+"/latest",{headers:{"X-Master-Key":API_KEY},cache:"no-store"});return (await r.json()).record;}catch(e){return {rooms:{}};}}
async function saveData(d){await fetch(BASE,{method:"PUT",headers:{"Content-Type":"application/json","X-Master-Key":API_KEY},body:JSON.stringify(d)});}

/* ===== ROOM LIST ===== */
async function renderRooms(){
  let d=await getData(); let list=document.getElementById("room-list"); list.innerHTML="";
  if(!d.rooms)d.rooms={};
  for(let r in d.rooms){
    let room=d.rooms[r]; let badge="";
    if(isSuperAdmin) badge=" üëë";
    else if(room.owner===myID) badge=" üíé";
    else if(room.admins && room.admins[myID]) badge=' üõ°Ô∏è';
    let div=document.createElement("div"); div.className="room-item"; div.innerHTML=r+badge;
    div.onclick=()=>openRoom(r); list.appendChild(div);
  }
}

/* ===== CREATE / JOIN ROOM ===== */
async function createRoom(){
  let name=document.getElementById("room-name").value.trim();
  let priv=document.getElementById("privateBox").checked;
  let pass=document.getElementById("room-pass").value.trim();
  if(!name) return alert("Enter room name");
  if(priv && !pass) return alert("Set password");
  let d=await getData(); if(!d.rooms)d.rooms={};
  if(d.rooms[name]) return alert("Room exists");
  d.rooms[name]={owner:myID,public:!priv,password:priv?pass:null,admins:{},messages:[]};
  if(isSuperAdmin) d.rooms[name].admins[myID]=true;
  await saveData(d);
  openRoom(name);
}
async function joinRoom(){
  let name=document.getElementById("room-name").value.trim();
  let d=await getData(); if(!d.rooms[name]) return alert("Room not found");
  if(!d.rooms[name].public){ let p=prompt("Enter password:"); if(p!==d.rooms[name].password) return alert("Wrong password"); }
  if(isSuperAdmin) d.rooms[name].admins[myID]=true;
  await saveData(d);
  openRoom(name);
}

/* ===== OPEN ROOM ===== */
async function openRoom(name){
  currentRoom=name; cachedMessages=[];
  hideAll(); document.getElementById("screen-chat").classList.remove("hidden");
  document.getElementById("room-title").textContent=name;
  document.getElementById("chat-box").innerHTML="";
  loadMessages();
}

/* ===== SEND MESSAGE ===== */
async function sendMsg(){
  let text=document.getElementById("msg").value.trim(); if(!text || !currentRoom) return;
  let d=await getData(); d.rooms[currentRoom].messages.push({u:myName,id:myID,text}); await saveData(d);
  document.getElementById("msg").value=""; checkInput(); loadMessages();
}

/* ===== FILES ===== */
function pickFile(){document.getElementById("fileInput").click();}
document.getElementById("fileInput").addEventListener("change",async function(){
  let file=this.files[0]; if(!file) return; if(file.size>5*1024*1024) return alert("Max 5MB");
  let reader=new FileReader();
  reader.onload=async()=>{
    let d=await getData();
    d.rooms[currentRoom].messages.push({u:myName,id:myID,file:reader.result,type:file.type});
    await saveData(d); loadMessages();
  };
  reader.readAsDataURL(file);
});

/* ===== LOAD MESSAGES ===== */
async function loadMessages(){
  if(!currentRoom) return;
  let d=await getData(); if(!d.rooms[currentRoom]){ showList(); return; }
  let room=d.rooms[currentRoom]; let msgs=room.messages; let box=document.getElementById("chat-box");
  for(let i=cachedMessages.length;i<msgs.length;i++){
    let m=msgs[i]; let div=document.createElement("div"); div.className="msg "+(m.id===myID?"msg-me":"msg-them");
    let badge=""; if(isSuperAdmin && m.id===myID) badge+=" üëë"; if(room.owner===m.id) badge+=" üíé"; if(room.admins && room.admins[m.id]) badge+=' üõ°Ô∏è';
    if(m.text) div.innerHTML=`<b>${m.u}${badge}</b><br>${m.text}`;
    if(m.file){
      if(m.type.startsWith("image")) div.innerHTML+='<br><img src="'+m.file+'">';
      if(m.type.startsWith("video")) div.innerHTML+='<br><video controls src="'+m.file+'"></video>';
    }
    box.appendChild(div);
  }
  cachedMessages=msgs.slice(); box.scrollTop=box.scrollHeight;
  renderAdminPanel(d);
  if(document.hidden && msgs.length>cachedMessages.length && Notification.permission==="granted") new Notification(`New message in ${currentRoom}`);
}

/* ===== ADMIN PANEL ===== */
function renderAdminPanel(d){
  let panel=document.getElementById("admin-panel"); let room=d.rooms[currentRoom];
  let allowed=isSuperAdmin || room.owner===myID || (room.admins && room.admins[myID]);
  if(!allowed){panel.classList.add("hidden"); return;} panel.classList.remove("hidden");
  let html="<b>Admin Panel</b><br>";
  let users={}; room.messages.forEach(m=>users[m.id]=m.u);
  for(let id in users){ let b=""; if(isSuperAdmin && id===myID) b+=" üëë"; if(room.owner===id) b+=" üíé"; if(room.admins && room.admins[id]) b+=' üõ°Ô∏è'; html+=users[id]+b+"<br>"; }
  html+="<button onclick='clearChat()'>Clear Chat</button>";
  panel.innerHTML=html;
}
async function clearChat(){if(!confirm("Clear chat?")) return; let d=await getData(); d.rooms[currentRoom].messages=[]; await saveData(d); cachedMessages=[]; loadMessages();}

/* ===== SETTINGS ===== */
function saveSettings(){
  let n=document.getElementById("settings-name").value.trim();
  let p=document.getElementById("settings-pin").value.trim();
  if(!n || !p) return alert("Cannot be empty");
  myName=n; pin=p; localStorage.setItem("name",n); localStorage.setItem("pin",p);
  isSuperAdmin=(p===SUPER_PIN); alert("Saved"); showList();
}

/* ===== POLLING ===== */
async function pollLoop(){if(currentRoom) await loadMessages(); setTimeout(pollLoop,1500);} pollLoop();
document.addEventListener("visibilitychange",()=>{if(!document.hidden && currentRoom) loadMessages();});
if(Notification.permission!=="granted") Notification.requestPermission();

showList();
</script>
</body>
</html>
