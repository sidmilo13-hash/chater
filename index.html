<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Messenger Pro</title>

<style>
:root { --primary:#075e54; --bg:#e5ddd5; --me:#dcf8c6; --them:#fff; }
body { font-family:-apple-system,sans-serif;background:#d1d7db;margin:0;display:flex;justify-content:center;align-items:center;height:100vh; }
.card { background:white;width:100%;max-width:400px;height:100vh;display:flex;flex-direction:column;box-shadow:0 4px 15px rgba(0,0,0,.1); position:relative; }
.hidden { display:none!important; }
header { background:#075e54;color:white;padding:15px;display:flex;justify-content:space-between;align-items:center; }
.room-item { padding:12px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;cursor:pointer; }
.room-item:hover { background:#f5f5f5; }
#chat-box { flex:1;overflow-y:auto;padding:15px;background:var(--bg);display:flex;flex-direction:column; }
.msg { margin:5px 0;padding:10px 15px;border-radius:15px;max-width:75%;font-size:14px;box-shadow:0 1px 1px rgba(0,0,0,.1); }
.msg-me { align-self:flex-end;background:var(--me); }
.msg-them { align-self:flex-start;background:var(--them); }
.msg-info { font-size:10px;color:#777;margin-bottom:3px;display:block; }
.input-area { padding:10px;background:#f0f0f0;display:flex;gap:10px; }
input { flex:1;padding:10px;border-radius:20px;border:1px solid #ccc; }
button { background:var(--primary);color:white;border:none;padding:8px 12px;border-radius:20px;font-size:12px;cursor:pointer; }
button:disabled { opacity:.5; }
.admin { background:#f3f3f3;padding:8px;margin:5px;border-radius:10px;font-size:12px; }
.user-admin { font-size:11px; color:#fff; background:#075e54; padding:2px 5px; border-radius:3px; margin-left:5px; }
.online { font-size:12px; }
.settings-cog { font-size:20px; cursor:pointer; }
.room-bottom { width:100%; padding:12px; font-size:16px; border:none; border-radius:0; text-align:center; background:var(--primary); color:white; cursor:pointer; position:absolute; bottom:0; left:0; }
.room-list-container { flex:1; overflow:auto; margin-bottom:60px; }
.settings-input { margin:5px 0; padding:8px; border-radius:5px; border:1px solid #ccc; width:100%; }
</style>
</head>
<body>

<!-- ROOM LIST -->
<div id="screen-list" class="card hidden">
<header>
<span>Messenger</span>
<span id="global-online" class="online">Online: 0</span>
<span class="settings-cog" onclick="showSettings()">‚öô</span>
</header>
<div id="room-list" class="room-list-container"></div>
<button class="room-bottom" onclick="showSetup()">+ New Chat</button>
</div>

<!-- CREATE / JOIN -->
<div id="screen-setup" class="card hidden" style="padding:20px;justify-content:center;">
<h3>Create / Join</h3>
<input id="room-name" placeholder="Room name">
<label><input type="checkbox" id="privateBox"> Private</label>
<input id="room-pass" placeholder="Password" type="password" style="display:none;margin-top:5px;">
<button onclick="createRoom()" style="margin-top:10px;">Create</button>
<button onclick="joinRoom()" style="margin-top:5px;background:#6c757d;">Join</button>
<button onclick="showList()" style="background:none;color:#555;margin-top:15px;">Cancel</button>
</div>

<!-- CHAT -->
<div id="screen-chat" class="card hidden">
<header>
<button onclick="showList()" style="background:none;">‚Üê</button>
<span id="room-title"></span>
<span id="room-online" class="online"></span>
</header>

<div id="admin-panel" class="admin hidden"></div>
<div id="chat-box"></div>

<div class="input-area">
<input id="msg" placeholder="Type message..." onkeypress="if(event.key==='Enter')sendMsg()">
<button onclick="sendMsg()">‚û§</button>
</div>
</div>

<!-- SETTINGS -->
<div id="screen-settings" class="card hidden" style="padding:20px;justify-content:center;">
<h3>Settings</h3>
<label>Name:</label>
<input id="settings-name" class="settings-input">
<label>PIN:</label>
<input id="settings-pin" type="password" class="settings-input">
<button onclick="saveSettings()">Save</button>
<button onclick="showList()" style="margin-top:10px;">Back</button>
</div>

<script>
/* ================= CONFIG ================= */
const BIN_ID = "6995c8e9ae596e708f347d9b";
const API_KEY = "$2a$10$Xoj7gk3UMX/Xu39sZjITbe1vTxinpZ3KjHuDNvIBeVmMqxBLt5HC.";
const BASE = "https://api.jsonbin.io/v3/b/" + BIN_ID;
const SUPER_PIN = "3108";

let myID = localStorage.getItem("uid") || crypto.randomUUID();
localStorage.setItem("uid", myID);

let myName = localStorage.getItem("name");
let pin = localStorage.getItem("pin") || prompt("Create PIN:");
if(!localStorage.getItem("pin")) localStorage.setItem("pin", pin);
if(prompt("Enter PIN:")!==localStorage.getItem("pin"))
    document.body.innerHTML="<h2 style='text-align:center'>Locked</h2>";

if(!myName){
    myName = prompt("Your name:");
    localStorage.setItem("name", myName);
}

let isSuperAdmin = (pin === SUPER_PIN);
let currentRoom=null;
let cache={rooms:{},online:{}};
let lastCount=0;
let roomOpen=false;

/* ================= DATA ================= */
async function fetchData(){
    const r = await fetch(BASE+"/latest",{headers:{"X-Master-Key":API_KEY},cache:"no-store"});
    cache = (await r.json()).record || {rooms:{},online:{}};
    if(!cache.rooms) cache.rooms={};
    if(!cache.online) cache.online={};
}

async function saveData(){
    await fetch(BASE,{
        method:"PUT",
        headers:{"Content-Type":"application/json","X-Master-Key":API_KEY},
        body:JSON.stringify(cache)
    });
}

/* ================= UI ================= */
function hideAll(){document.querySelectorAll(".card").forEach(c=>c.classList.add("hidden"));}
function showList(){roomOpen=false;hideAll();document.getElementById("screen-list").classList.remove("hidden");renderRooms();}
function showSetup(){hideAll();document.getElementById("screen-setup").classList.remove("hidden");}
function showSettings(){hideAll();document.getElementById("screen-settings").classList.remove("hidden");
document.getElementById("settings-name").value=myName;
document.getElementById("settings-pin").value=pin;}

/* ================= ROOMS ================= */
async function renderRooms(){
    await fetchData();
    let list=document.getElementById("room-list");
    list.innerHTML="";
    for(let r in cache.rooms){
        let badge="";
        if(isSuperAdmin) badge=" üëë";
        else if(cache.rooms[r].admins && cache.rooms[r].admins[myID])
            badge=' <span class="user-admin">Admin</span>';
        let div=document.createElement("div");
        div.className="room-item";
        div.innerHTML=`# ${r}${badge}`;
        div.onclick=()=>openRoom(r);
        list.appendChild(div);
    }
    document.getElementById("global-online").textContent="Online: "+Object.keys(cache.online).length;
}

async function createRoom(){
    let r=document.getElementById("room-name").value.trim();
    if(!r) return alert("Enter room name");
    await fetchData();
    if(cache.rooms[r]) return alert("Room exists");
    let priv=document.getElementById("privateBox").checked;
    let pass=document.getElementById("room-pass").value;
    cache.rooms[r]={owner:myID,public:!priv,password:priv?pass:null,messages:[],admins:{},kicked:{}};
    if(isSuperAdmin) cache.rooms[r].admins[myID]=true;
    await saveData();
    openRoom(r);
}

async function joinRoom(){
    let r=document.getElementById("room-name").value.trim();
    await fetchData();
    if(!cache.rooms[r]) return alert("Room not found");
    if(!cache.rooms[r].public){
        let p=prompt("Password:");
        if(p!==cache.rooms[r].password) return alert("Wrong password");
    }
    if(isSuperAdmin) cache.rooms[r].admins[myID]=true;
    await saveData();
    openRoom(r);
}

async function openRoom(r){
    currentRoom=r;
    lastCount=0;
    roomOpen=true;
    hideAll();
    document.getElementById("screen-chat").classList.remove("hidden");
    document.getElementById("room-title").textContent=r;
    loadMessages();
}

/* ================= CHAT ================= */
async function sendMsg(){
    let text=document.getElementById("msg").value.trim();
    if(!text) return;
    await fetchData();
    cache.rooms[currentRoom].messages.push({u:myName,id:myID,m:text,t:Date.now()});
    await saveData();
    document.getElementById("msg").value="";
    loadMessages();
}

async function loadMessages(){
    if(!roomOpen) return;
    await fetchData();
    let msgs=cache.rooms[currentRoom].messages;
    let box=document.getElementById("chat-box");
    for(let i=lastCount;i<msgs.length;i++){
        let m=msgs[i];
        let div=document.createElement("div");
        div.className="msg "+(m.id===myID?"msg-me":"msg-them");
        div.innerHTML=`<span class="msg-info">${m.u}</span>${m.m}`;
        box.appendChild(div);
    }
    lastCount=msgs.length;
    box.scrollTop=box.scrollHeight;
    renderAdminPanel();
}

/* ================= ADMIN ================= */
function renderAdminPanel(){
    let room=cache.rooms[currentRoom];
    let admin=document.getElementById("admin-panel");
    let allowed=isSuperAdmin||room.owner===myID||(room.admins&&room.admins[myID]);
    if(!allowed){admin.classList.add("hidden");return;}
    admin.classList.remove("hidden");
    let users={}; room.messages.forEach(m=>users[m.id]=m.u);
    let html="<b>Admin Panel</b><br>";
    for(let id in users){
        let badge="";
        if(isSuperAdmin&&id===myID) badge=" üëë";
        else if(room.admins&&room.admins[id]) badge=' <span class="user-admin">Admin</span>';
        html+=`${users[id]}${badge} `;
        if(id!==myID){
            html+=`<button onclick="toggleAdmin('${id}')">Admin</button>`;
            html+=`<button onclick="kickUser('${id}')">Kick</button>`;
        }
        html+="<br>";
    }
    html+="<br><button onclick='clearChat()'>Clear Chat</button>";
    html+="<button onclick='deleteRoom()'>Delete Room</button>";
    admin.innerHTML=html;
}

async function toggleAdmin(id){
    await fetchData();
    let room=cache.rooms[currentRoom];
    if(!room.admins) room.admins={};
    room.admins[id]=!room.admins[id];
    await saveData();
    loadMessages();
}

async function kickUser(id){
    await fetchData();
    cache.rooms[currentRoom].kicked[id]=true;
    await saveData();
    alert("User kicked");
}

async function clearChat(){
    if(!confirm("Clear chat?")) return;
    await fetchData();
    cache.rooms[currentRoom].messages=[];
    await saveData();
    document.getElementById("chat-box").innerHTML="";
}

async function deleteRoom(){
    if(!confirm("Delete room?")) return;
    await fetchData();
    delete cache.rooms[currentRoom];
    await saveData();
    showList();
}

/* ================= SETTINGS ================= */
function saveSettings(){
    let newName=document.getElementById("settings-name").value.trim();
    let newPin=document.getElementById("settings-pin").value.trim();
    if(!newName||!newPin) return alert("Cannot be empty");
    myName=newName;
    pin=newPin;
    localStorage.setItem("name",newName);
    localStorage.setItem("pin",newPin);
    isSuperAdmin=(newPin===SUPER_PIN);
    alert("Updated!");
    showList();
}

/* ================= HEARTBEAT ================= */
async function heartbeat(){
    if(!roomOpen) return;
    await fetchData();
    cache.online[myID]={room:currentRoom,time:Date.now()};
    await saveData();
}
setInterval(()=>{if(roomOpen)loadMessages();},3000);
setInterval(()=>{if(roomOpen)heartbeat();},15000);

showList();
</script>
</body>
</html>
