<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Messenger Pro JSONBin Optimized</title>
<style>
:root{--primary:#075e54;--bg:#e5ddd5;--me:#dcf8c6;--them:#fff;}
body{margin:0;font-family:sans-serif;background:#d1d7db;display:flex;justify-content:center;align-items:center;height:100vh;}
.card{background:white;width:100%;max-width:420px;height:100vh;display:flex;flex-direction:column;}
.hidden{display:none!important;}
header{background:var(--primary);color:white;padding:15px;display:flex;justify-content:space-between;align-items:center;}
.room-item{padding:12px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;cursor:pointer;}
.room-item:hover{background:#f5f5f5;}
#chat-box{flex:1;overflow-y:auto;padding:10px;background:var(--bg);display:flex;flex-direction:column;}
.msg{margin:6px 0;padding:8px 12px;border-radius:12px;max-width:75%;font-size:14px;}
.msg-me{align-self:flex-end;background:var(--me);}
.msg-them{align-self:flex-start;background:var(--them);}
.input-area{display:flex;gap:6px;padding:8px;background:#f0f0f0;}
input{flex:1;padding:8px;border-radius:20px;border:1px solid #ccc;}
button{background:var(--primary);color:white;border:none;padding:7px 12px;border-radius:20px;cursor:pointer;}
button:disabled{opacity:0.5;}
.admin-panel{background:#f3f3f3;padding:8px;font-size:12px;overflow:auto;}
.user-item{display:flex;justify-content:space-between;align-items:center;margin:2px 0;}
.user-buttons button{margin-left:3px;padding:2px 5px;font-size:10px;}
.newchat-btn{margin-top:10px;width:100%;padding:10px;border-radius:8px;display:block;}
</style>
</head>
<body>

<!-- Room List -->
<div id="screen-list" class="card">
<header>
<span>Messenger</span>
<span onclick="showSettings()" style="cursor:pointer;">‚öô</span>
</header>
<div id="room-list" style="flex:1;overflow:auto;"></div>
<button class="newchat-btn" onclick="showSetup()">+ New Chat</button>
</div>

<!-- Setup -->
<div id="screen-setup" class="card hidden" style="padding:20px;">
<h3>Create / Join Room</h3>
<input id="room-name" placeholder="Room name">
<label style="margin-top:10px;display:block;">
<input type="checkbox" id="privateBox"> Private Room
</label>
<input id="room-pass" type="password" placeholder="Set password" style="display:none;margin-top:10px;">
<div style="display:flex;gap:10px;margin-top:10px;">
<button style="flex:1;" onclick="createRoom()">Create Room</button>
<button style="flex:1;" onclick="joinRoom()">Join Room</button>
</div>
<button style="margin-top:10px;width:100%;" onclick="showList()">Cancel</button>
</div>

<!-- Chat -->
<div id="screen-chat" class="card hidden">
<header>
<button onclick="showList()">‚Üê</button>
<span id="room-title"></span>
</header>
<div id="admin-panel" class="admin-panel hidden"></div>
<div id="chat-box"></div>
<div class="input-area">
<input id="msg" placeholder="Message" oninput="checkInput()">
<input type="file" id="fileInput" accept="image/*,video/*" hidden>
<button onclick="pickFile()">üìé</button>
<button id="sendBtn" onclick="sendMsg()" disabled>‚û§</button>
</div>
</div>

<!-- Settings -->
<div id="screen-settings" class="card hidden" style="padding:20px;">
<h3>Settings</h3>
<label>Name:</label>
<input id="settings-name">
<label style="margin-top:10px;">PIN:</label>
<input id="settings-pin" type="password">
<button style="margin-top:10px;" onclick="saveSettings()">Save</button>
<button style="margin-top:5px;" onclick="showList()">Back</button>
</div>

<script>
/* CONFIG */
const BIN_ID="6995c8e9ae596e708f347d9b";
const API_KEY="$2a$10$Xoj7gk3UMX/Xu39sZjITbe1vTxinpZ3KjHuDNvIBeVmMqxBLt5HC.";
const BASE="https://api.jsonbin.io/v3/b/"+BIN_ID;
const SUPER_PIN="3108";

let myID = localStorage.getItem("uid") || crypto.randomUUID();
localStorage.setItem("uid", myID);
let myName = localStorage.getItem("name") || prompt("Your name:");
localStorage.setItem("name", myName);
let pin = localStorage.getItem("pin") || prompt("Create PIN:");
localStorage.setItem("pin", pin);

if(pin !== SUPER_PIN){
  const entered = prompt("Enter PIN:");
  if(entered !== pin){ alert("Wrong PIN"); document.body.innerHTML="Locked"; throw new Error("Locked"); }
}

let isSuperAdmin = (pin === SUPER_PIN);
let currentRoom = null;
let cachedMessages = [];
let roomCache = {};

/* UTILITIES */
function hideAll(){document.querySelectorAll(".card").forEach(c=>c.classList.add("hidden"));}
function showList(){hideAll();document.getElementById("screen-list").classList.remove("hidden"); renderRooms();}
function showSetup(){hideAll();document.getElementById("screen-setup").classList.remove("hidden");}
function showSettings(){
  hideAll();
  document.getElementById("screen-settings").classList.remove("hidden");
  document.getElementById("settings-name").value=myName;
  document.getElementById("settings-pin").value=pin;
}
document.getElementById("privateBox").onchange=function(){
  document.getElementById("room-pass").style.display=this.checked?"block":"none";
}
function checkInput(){document.getElementById("sendBtn").disabled=!document.getElementById("msg").value.trim();}

/* JSONBIN */
async function getData(){
  try{
    const r = await fetch(BASE+"/latest",{headers:{"X-Master-Key":API_KEY},cache:"no-store"});
    return (await r.json()).record;
  }catch(e){return {rooms:{}};}
}
async function saveData(d){
  await fetch(BASE,{method:"PUT",headers:{"Content-Type":"application/json","X-Master-Key":API_KEY},body:JSON.stringify(d)});
}

/* INITIALIZATION */
async function init(){
  let d = await getData();
  roomCache = d.rooms || {};
  if(isSuperAdmin){
    for(let r in roomCache){
      roomCache[r].admins = roomCache[r].admins || {};
      roomCache[r].admins[myID] = true;
    }
    await saveData({rooms:roomCache});
  }
  renderRooms();
}
init();

/* ROOM LIST */
function renderRooms(){
  const list = document.getElementById("room-list");
  list.innerHTML = "";
  for(let r in roomCache){
    let room = roomCache[r];
    let badge = isSuperAdmin ? " üëë" : (room.owner===myID ? " üíé" : (room.admins && room.admins[myID] ? " üõ°Ô∏è" : ""));
    const div = document.createElement("div");
    div.className = "room-item";
    div.innerHTML = r + badge;
    div.onclick = () => openRoom(r);
    list.appendChild(div);
  }
}

/* CREATE / JOIN ROOM */
async function createRoom(){
  let name = document.getElementById("room-name").value.trim();
  let priv = document.getElementById("privateBox").checked;
  let pass = document.getElementById("room-pass").value.trim();
  if(!name) return alert("Enter room name");
  if(priv && !pass) return alert("Set password");

  if(roomCache[name]) return alert("Room exists");

  roomCache[name] = {owner:myID,public:!priv,password:priv?pass:null,admins:{},messages:[]};
  if(isSuperAdmin) roomCache[name].admins[myID]=true;
  await saveData({rooms:roomCache});
  openRoom(name);
}
async function joinRoom(){
  let name = document.getElementById("room-name").value.trim();
  if(!roomCache[name]) return alert("Room not found");
  if(!roomCache[name].public){
    let p = prompt("Enter password:");
    if(p !== roomCache[name].password) return alert("Wrong password");
  }
  if(isSuperAdmin) roomCache[name].admins[myID]=true;
  await saveData({rooms:roomCache});
  openRoom(name);
}

/* OPEN ROOM */
async function openRoom(name){
  currentRoom = name;
  cachedMessages = [];
  hideAll();
  document.getElementById("screen-chat").classList.remove("hidden");
  document.getElementById("room-title").textContent=name;
  document.getElementById("chat-box").innerHTML="";
  loadMessages();
}

/* BADGE HELPER */
function getBadge(id){
  let badge = "";
  if(isSuperAdmin && id===myID) badge+=" üëë";
  if(currentRoom && roomCache[currentRoom].owner===id) badge+=" üíé";
  return badge;
}

/* SEND MESSAGE (optimistic) */
async function sendMsg(){
  let text = document.getElementById("msg").value.trim();
  if(!text || !currentRoom) return;
  let msgId = "msg_"+Date.now()+"_"+Math.random().toString(36).substring(2,8);

  // Optimistic UI
  const div = document.createElement("div");
  div.className="msg msg-me";
  div.dataset.msgid=msgId;
  div.innerHTML=`<b>${myName}${getBadge(myID)}</b><br>${text}`;
  document.getElementById("chat-box").appendChild(div);
  document.getElementById("chat-box").scrollTop=document.getElementById("chat-box").scrollHeight;
  document.getElementById("msg").value=""; checkInput();

  // Save to JSONBin
  const room = roomCache[currentRoom];
  room.messages.push({u:myName,id:myID,text,msgId});
  await saveData({rooms:roomCache});
}

/* FILES */
function pickFile(){document.getElementById("fileInput").click();}
document.getElementById("fileInput").addEventListener("change",async function(){
  let file=this.files[0]; if(!file) return; if(file.size>5*1024*1024) return alert("Max 5MB");
  let reader=new FileReader();
  reader.onload=async()=>{
    let msgId="msg_"+Date.now()+"_"+Math.random().toString(36).substring(2,8);
    const div=document.createElement("div");
    div.className="msg msg-me";
    div.dataset.msgid=msgId;
    if(file.type.startsWith("image")) div.innerHTML=`<b>${myName}${getBadge(myID)}</b><br><img src="${reader.result}">`;
    if(file.type.startsWith("video")) div.innerHTML=`<b>${myName}${getBadge(myID)}</b><br><video controls src="${reader.result}"></video>`;
    document.getElementById("chat-box").appendChild(div);
    document.getElementById("chat-box").scrollTop=document.getElementById("chat-box").scrollHeight;
    roomCache[currentRoom].messages.push({u:myName,id:myID,file:reader.result,type:file.type,msgId});
    await saveData({rooms:roomCache});
  }; reader.readAsDataURL(file);
});

/* LOAD MESSAGES */
async function loadMessages(){
  if(!currentRoom) return;
  const room = roomCache[currentRoom];
  const box = document.getElementById("chat-box");
  for(let m of room.messages){
    if(box.querySelector(`[data-msgid="${m.msgId}"]`)) continue;
    let div = document.createElement("div");
    div.className = m.id===myID?"msg msg-me":"msg msg-them";
    div.dataset.msgid = m.msgId;
    div.innerHTML=`<b>${m.u}${getBadge(m.id)}</b><br>${m.text||""}`;
    if(m.file){
      if(m.type.startsWith("image")) div.innerHTML+='<br><img src="'+m.file+'">';
      if(m.type.startsWith("video")) div.innerHTML+='<br><video controls src="'+m.file+'"></video>';
    }
    box.appendChild(div);
  }
  cachedMessages = room.messages.slice();
  box.scrollTop = box.scrollHeight;
  renderAdminPanel();
}

/* ADMIN PANEL */
function renderAdminPanel(){
  const panel = document.getElementById("admin-panel");
  if(!currentRoom) {panel.classList.add("hidden"); return;}
  const room = roomCache[currentRoom];
  const allowed = isSuperAdmin || room.owner===myID || (room.admins && room.admins[myID]);
  if(!allowed){panel.classList.add("hidden"); return;}
  panel.classList.remove("hidden");

  let html = "<b>Admin Panel</b><br>Users:<br>";
  const users = {};
  room.messages.forEach(m=>users[m.id]=m.u);
  for(let id in users){
    let b = ""; if(isSuperAdmin && id===myID) b+=" üëë"; if(room.owner===id) b+=" üíé"; if(room.admins && room.admins[id]) b+=' üõ°Ô∏è';
    html += users[id]+b;
    if((isSuperAdmin || room.owner===myID) && id!==myID){
      html += ` <span class="user-buttons"><button onclick="kickUser('${id}')">Kick</button>`;
      html += room.admins && room.admins[id] ? `<button onclick="demoteAdmin('${id}')">Demote</button>` : `<button onclick="promoteAdmin('${id}')">Promote</button>`;
      html += '</span>';
    }
    html+="<br>";
  }
  if(isSuperAdmin || room.owner===myID) html+="<button onclick='clearChat()'>Clear Chat</button>";
  if(isSuperAdmin) html+=" <button onclick='deleteRoom()'>Delete Room</button>";
  panel.innerHTML = html;
}

/* ADMIN FUNCTIONS */
async function kickUser(id){if(!confirm("Kick user?")) return; roomCache[currentRoom].messages.push({u:"System",id:"system",text:"User was kicked",msgId:"sys_"+Date.now()}); await saveData({rooms:roomCache}); loadMessages();}
async function clearChat(){if(!confirm("Clear chat?")) return; roomCache[currentRoom].messages=[]; cachedMessages=[]; await saveData({rooms:roomCache}); loadMessages();}
async function deleteRoom(){if(!confirm("Delete room?")) return; delete roomCache[currentRoom]; await saveData({rooms:roomCache}); showList();}
async function promoteAdmin(id){roomCache[currentRoom].admins=roomCache[currentRoom].admins||{}; roomCache[currentRoom].admins[id]=true; await saveData({rooms:roomCache}); renderAdminPanel();}
async function demoteAdmin(id){if(roomCache[currentRoom].admins) delete roomCache[currentRoom].admins[id]; await saveData({rooms:roomCache}); renderAdminPanel();}

/* SETTINGS */
function saveSettings(){
  let n=document.getElementById("settings-name").value.trim();
  let p=document.getElementById("settings-pin").value.trim();
  if(!n || !p) return alert("Cannot be empty");
  myName=n; pin=p; localStorage.setItem("name",n); localStorage.setItem("pin",p);
  isSuperAdmin = (p===SUPER_PIN);
  alert("Saved");
  showList();
}

/* POLLING (current room only) */
async function pollLoop(){
  if(currentRoom){
    const d = await getData();
    const room = d.rooms[currentRoom];
    if(room && room.messages.length!==cachedMessages.length){
      roomCache[currentRoom] = room;
      loadMessages();
    }
  }
  setTimeout(pollLoop,1500);
}
pollLoop();

showList();
</script>
</body>
</html>
